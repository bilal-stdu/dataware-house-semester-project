CREATE DATABASE DW
USE DW


CREATE TABLE DIM_PRODUCT
(
   PRODUCT_ID INT NOT NULL PRIMARY KEY,
   PRODUCT_NAME VARCHAR(50) NOT NULL,
   PRODUCT_CATEGORY VARCHAR(50) NOT NULL,
);

INSERT INTO DIM_PRODUCT(PRODUCT_ID, PRODUCT_NAME, PRODUCT_CATEGORY)
SELECT DISTINCT (PRODUCTS.PRODUCT_ID), 
PRODUCTS.PRODUCT_NAME, PRODUCT_CATEGORY.CATEGORY_NAME
FROM [DWDM_PROJECT].[DBO].PRODUCTS
JOIN [DWDM_PROJECT].[DBO].PRODUCT_CATEGORY
ON PRODUCTS.PRD_CATEGORY_ID = PRODUCT_CATEGORY.PRD_CATEGORY_ID
JOIN [DWDM_PROJECT].[DBO].ORDER_LINE
ON PRODUCTS.PRODUCT_ID = [DWDM_PROJECT].[DBO].ORDER_LINE.PRODUCT_ID
ORDER BY PRODUCTS.PRODUCT_ID ASC;

CREATE TABLE DIM_CUSTOMERS
(
  CUSTOMER_ID INT NOT NULL PRIMARY KEY,
  CUSTOMER_NAME VARCHAR(50),
);

INSERT INTO DIM_CUSTOMERS(CUSTOMER_ID, CUSTOMER_NAME)
SELECT CUSTOMERS_ID,CUSTOMER_NAME FROM [DWDM_PROJECT].[DBO].CUSTOMERS

CREATE TABLE DIM_TIME
(
  ORDER_LINEID INT NOT NULL PRIMARY KEY,
  ORDER_DATE DATE,
  YEAR INT,
  QUARTER INT,
  MONTH INT,
  DAY INT,
);
INSERT INTO DIM_TIME(ORDER_LINEID, ORDER_DATE, YEAR, QUARTER, MONTH, DAY)
SELECT [DWDM_PROJECT].[DBO].ORDER_LINE.ORDERLINE_ID, [DWDM_PROJECT].[DBO].ORDERS.ORDER_DATE, 
YEAR([DWDM_PROJECT].[DBO].ORDERS.ORDER_DATE) AS Year, 
DATEPART(qq, [DWDM_PROJECT].[DBO].ORDERS.ORDER_DATE) AS QUARTER, 
MONTH([DWDM_PROJECT].[DBO].ORDERS.ORDER_DATE) AS MONTH,
DATEPART(dd, [DWDM_PROJECT].[DBO].ORDERS.ORDER_DATE) AS DAY
FROM [DWDM_PROJECT].[DBO].ORDER_LINE
JOIN [DWDM_PROJECT].[DBO].ORDERS ON
[DWDM_PROJECT].[DBO].ORDER_LINE.ORDER_ID = [DWDM_PROJECT].[DBO].ORDERS.ORDER_ID



CREATE TABLE DIM_EMPLOYEES
(
	EMPLOYEES_ID INT NOT NULL PRIMARY KEY,
	EMPLOYEE_NAME VARCHAR(100),
)
INSERT INTO DIM_EMPLOYEES(EMPLOYEES_ID, EMPLOYEE_NAME)
SELECT EMPLOYEES_ID,EMPLOYEE_NAME FROM [DWDM_PROJECT].[DBO].EMPLOYEES

CREATE TABLE FACT_SALES
(
   ORDER_LINEID INT FOREIGN KEY REFERENCES DIM_TIME(ORDER_LINEID),
   CUSTOMER_ID INT FOREIGN KEY REFERENCES DIM_CUSTOMERS(CUSTOMER_ID),
   EMPLOYEES_ID INT FOREIGN KEY REFERENCES DIM_EMPLOYEES(EMPLOYEES_ID),
   PRODUCT_ID INT FOREIGN KEY REFERENCES DIM_PRODUCT(PRODUCT_ID),
   PRD_QUANTITY INT,
   TOTALSALEAMOUNT INT NOT NULL,
   TOTALPURCHASEAMOUNT INT NOT NULL,
   PROFIT INT 
   
);
 


INSERT INTO FACT_SALES(ORDER_LINEID, CUSTOMER_ID, EMPLOYEES_ID, PRODUCT_ID, PRD_QUANTITY, TOTALSALEAMOUNT, TOTALPURCHASEAMOUNT, PROFIT )
SELECT DISTINCT [DWDM_PROJECT].[DBO].ORDER_LINE.ORDERLINE_ID,[DWDM_PROJECT].[DBO].ORDERS.CUSTOMERS_ID,[DWDM_PROJECT].[DBO].ORDERS.EMPLOYEES_ID,
[DWDM_PROJECT].[DBO].ORDER_LINE.PRODUCT_ID,
[DWDM_PROJECT].[DBO].ORDER_LINE.PRD_QUANTITY,
[DWDM_PROJECT].[DBO].ORDER_LINE.PRICE_EACH * [DWDM_PROJECT].[DBO].ORDER_LINE.PRD_QUANTITY AS [TOTAL SALE AAMOUNT],
[DWDM_PROJECT].[DBO].PURCHASE_DETAILS.PURCHASE_PRICE * [DWDM_PROJECT].[DBO].ORDER_LINE.PRD_QUANTITY AS [TOTAL PURCHASE AMOUNT], 
(([DWDM_PROJECT].[DBO].ORDER_LINE.PRICE_EACH - [DWDM_PROJECT].[DBO].PURCHASE_DETAILS.PURCHASE_PRICE) * [DWDM_PROJECT].[DBO].ORDER_LINE.PRD_QUANTITY) AS [TOTAL PROFIT]
FROM [DWDM_PROJECT].[DBO].ORDER_LINE
INNER JOIN [DWDM_PROJECT].[DBO].ORDERS
ON [DWDM_PROJECT].[DBO].ORDER_LINE.ORDER_ID = [DWDM_PROJECT].[DBO].ORDERS.ORDER_ID
INNER JOIN [DWDM_PROJECT].[DBO].PURCHASE_DETAILS
ON [DWDM_PROJECT].[DBO].ORDER_LINE.PRODUCT_ID = [DWDM_PROJECT].[DBO].PURCHASE_DETAILS.PRODUCT_ID
ORDER BY ORDERLINE_ID ASC;




SELECT * FROM DIM_CUSTOMERS
SELECT * FROM DIM_PRODUCT
SELECT * FROM DIM_TIME
SELECT * FROM FACT_SALES

DELETE FROM DIM_TIME
DELETE FROM FACT_SALES